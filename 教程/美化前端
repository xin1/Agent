<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>PDFå‰ªè£ä¸æå–å·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-5">
    <h2 class="mb-4 text-center text-primary">ğŸ“„ PDFè£å‰ªä¸ç»“æ„æå–å·¥å…·</h2>
    <form id="upload-form" enctype="multipart/form-data" class="bg-white p-4 shadow rounded">
        <div class="mb-3">
            <label for="file" class="form-label">ä¸Šä¼ PDFæ–‡ä»¶</label>
            <input class="form-control" type="file" id="file" name="file" accept="application/pdf" required>
        </div>
        <div class="row mb-3">
            <div class="col">
                <label class="form-label">ä¸Šè¾¹è·è£å‰ª (cm)</label>
                <input class="form-control" type="number" name="top_cm" value="2.5" step="0.1">
            </div>
            <div class="col">
                <label class="form-label">ä¸‹è¾¹è·è£å‰ª (cm)</label>
                <input class="form-control" type="number" name="bottom_cm" value="2.5" step="0.1">
            </div>
        </div>
        <button class="btn btn-primary w-100" type="submit">æäº¤å¤„ç†</button>
    </form>

    <div id="preview" class="text-center my-4" style="display:none;">
        <h5 class="text-success">âœ… é¢„è§ˆå‰ªè£æ•ˆæœ</h5>
        <img id="preview-image" class="img-fluid border rounded shadow" alt="è£å‰ªé¢„è§ˆå›¾">
    </div>

    <div id="download-links" class="text-center mt-4" style="display:none;">
        <a id="pdf-link" class="btn btn-success me-2" download>ä¸‹è½½è£å‰ªå PDF</a>
        <a id="csv-link" class="btn btn-outline-primary" download>ä¸‹è½½ç»“æ„åŒ– CSV</a>
    </div>
</div>

<script>
document.getElementById("upload-form").addEventListener("submit", async function (e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);
    const file = form.file.files[0];

    if (!file) return alert("è¯·é€‰æ‹©ä¸€ä¸ª PDF æ–‡ä»¶");

    const response = await fetch("/process/", {
        method: "POST",
        body: formData
    });

    if (!response.ok) {
        alert("å¤„ç†å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–é‡è¯•");
        return;
    }

    const result = await response.json();
    document.getElementById("preview").style.display = "block";
    document.getElementById("preview-image").src = `/preview/?pdf_path=${encodeURIComponent(result.pdf)}`;

    document.getElementById("download-links").style.display = "block";
    document.getElementById("pdf-link").href = `/download/?path=${encodeURIComponent(result.pdf)}`;
    document.getElementById("csv-link").href = `/download/?path=${encodeURIComponent(result.csv)}`;
});
</script>
</body>
</html>

from fastapi import FastAPI, UploadFile, File, Form
from fastapi.responses import FileResponse, JSONResponse
from fastapi.staticfiles import StaticFiles
import os
from io import BytesIO
from PyPDF2 import PdfReader, PdfWriter
import pandas as pd

app = FastAPI()

# é™æ€æ–‡ä»¶ç›®å½•ï¼Œä¾›å‰ç«¯é¢„è§ˆå’Œä¸‹è½½ä½¿ç”¨
app.mount("/static", StaticFiles(directory="static"), name="static")

# ä¸´æ—¶ç›®å½•
TEMP_DIR = "temp"

# ç¡®ä¿ä¸´æ—¶ç›®å½•å­˜åœ¨
os.makedirs(TEMP_DIR, exist_ok=True)

def crop_pdf(input_path: str, output_path: str, top_cm: float, bottom_cm: float):
    # è£å‰ªPDFå‡½æ•°
    reader = PdfReader(input_path)
    writer = PdfWriter()

    # è½¬æ¢å˜ç±³ä¸ºç‚¹ï¼ˆ1 cm â‰ˆ 28.35 pointsï¼‰
    top = top_cm * 28.35
    bottom = bottom_cm * 28.35

    # å¯¹æ¯ä¸€é¡µè¿›è¡Œè£å‰ª
    for page_num in range(len(reader.pages)):
        page = reader.pages[page_num]
        page.cropbox.upper_left = (0, top)  # å·¦ä¸Š
        page.cropbox.lower_right = (page.mediabox.width, page.mediabox.height - bottom)  # å³ä¸‹
        writer.add_page(page)

    # ä¿å­˜è£å‰ªåçš„PDF
    with open(output_path, "wb") as out_file:
        writer.write(out_file)

def generate_csv_from_pdf(input_path: str) -> str:
    # ç¤ºä¾‹å‡½æ•°ï¼šä»PDFæå–ä¸€äº›ç»“æ„åŒ–æ•°æ®
    # è¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿï¼Œå°†PDFé¡µé¢æ•°ä½œä¸ºç»“æ„åŒ–æ•°æ®
    reader = PdfReader(input_path)
    data = {"page_number": list(range(1, len(reader.pages) + 1))}
    df = pd.DataFrame(data)
    
    # ä¿å­˜ä¸ºCSV
    csv_path = os.path.join(TEMP_DIR, "output.csv")
    df.to_csv(csv_path, index=False)
    return csv_path

@app.post("/process/")
async def process_pdf(file: UploadFile = File(...), top_cm: float = Form(2.5), bottom_cm: float = Form(2.5)):
    # ä¿å­˜ä¸Šä¼ çš„PDFæ–‡ä»¶
    input_pdf_path = os.path.join(TEMP_DIR, file.filename)
    with open(input_pdf_path, "wb") as f:
        f.write(await file.read())

    # è¾“å‡ºè£å‰ªåçš„PDFè·¯å¾„
    output_pdf_path = os.path.join(TEMP_DIR, f"cropped_{file.filename}")
    crop_pdf(input_pdf_path, output_pdf_path, top_cm, bottom_cm)

    # ç”Ÿæˆç»“æ„åŒ–CSV
    csv_path = generate_csv_from_pdf(input_pdf_path)

    # è¿”å›å¤„ç†ç»“æœ
    return JSONResponse(content={
        "pdf": output_pdf_path.replace(TEMP_DIR + "/", ""),
        "csv": csv_path.replace(TEMP_DIR + "/", "")
    })

@app.get("/preview/")
async def preview_pdf(pdf_path: str):
    # è¿”å›è£å‰ªåçš„PDFé¢„è§ˆï¼ˆè¿™é‡Œå‡è®¾å‰ç«¯ä¼ çš„æ˜¯ä¸€ä¸ªå›¾ç‰‡è·¯å¾„ï¼Œå®é™…å¯ç”¨PDFæ¸²æŸ“å™¨å¦‚PDF.jsï¼‰
    return FileResponse(pdf_path)

@app.get("/download/")
async def download_file(path: str):
    file_path = os.path.join(TEMP_DIR, path)
    if os.path.exists(file_path):
        return FileResponse(file_path, media_type="application/octet-stream", filename=path)
    return JSONResponse(content={"message": "File not found"}, status_code=404)


project/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py              # FastAPI åç«¯æœåŠ¡å…¥å£
â”‚   â”œâ”€â”€ pdf_processor.py     # å‰ªè£ PDF å’Œç»“æ„åŒ–æå–é€»è¾‘
â”‚   â”œâ”€â”€ utils.py             # ä¸­é—´é¡µç”Ÿæˆé¢„è§ˆå›¾çš„å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ static/
â”‚   â”‚   â””â”€â”€ index.html       # å‰ç«¯ç½‘é¡µï¼ˆä¸Šä¼ ã€é¢„è§ˆã€ä¸‹è½½ï¼‰
â”‚   â””â”€â”€ outputs/             # ç”Ÿæˆçš„ PDF/CSV/JPEG ä¸´æ—¶æ–‡ä»¶ç›®å½•
â”œâ”€â”€ Dockerfile               # Docker æ„å»ºæ–‡ä»¶
â”œâ”€â”€ requirements.txt         # ä¾èµ–æ¸…å•
â””â”€â”€ README.md                # éƒ¨ç½²ä¸ä½¿ç”¨è¯´æ˜

# --- app/pdf_processor.py ---
import fitz  # PyMuPDF
import re
import os

def crop_pdf(input_pdf, output_pdf, top_crop, bottom_crop):
    doc = fitz.open(input_pdf)
    for page in doc:
        rect = page.rect
        crop_rect = fitz.Rect(
            rect.x0, rect.y0 + top_crop, rect.x1, rect.y1 - bottom_crop
        )
        page.set_cropbox(crop_rect)
    doc.save(output_pdf)
    doc.close()

def extract_text_to_csv(input_pdf, output_csv, top_crop, bottom_crop):
    import csv
    doc = fitz.open(input_pdf)
    with open(output_csv, 'w', newline='', encoding='utf-8-sig') as f:
        writer = csv.writer(f)
        writer.writerow(['æ ‡é¢˜', 'å†…å®¹'])
        current_title = None
        current_content = []
        for page in doc:
            rect = page.rect
            crop_rect = fitz.Rect(rect.x0, rect.y0 + top_crop, rect.x1, rect.y1 - bottom_crop)
            text = page.get_text(clip=crop_rect)
            if not text:
                continue
            for line in text.split('\n'):
                line = line.strip()
                if not line:
                    continue
                if is_header(line):
                    if current_title:
                        writer.writerow([current_title, '\n'.join(current_content)])
                    current_title = line
                    current_content = []
                else:
                    current_content.append(line)
        if current_title:
            writer.writerow([current_title, '\n'.join(current_content)])
    doc.close()

def is_header(line):
    return bool(re.match(r'^\d+(\.\d+){0,2}\s+', line)) and len(line) <= 50

# --- app/utils.py ---
import fitz
from PIL import Image

def generate_middle_preview(input_pdf, output_image_path, top_crop, bottom_crop):
    doc = fitz.open(input_pdf)
    if len(doc) == 0:
        return False
    mid_index = len(doc) // 2
    page = doc[mid_index]
    rect = page.rect
    crop_rect = fitz.Rect(
        rect.x0, rect.y0 + top_crop, rect.x1, rect.y1 - bottom_crop
    )
    pix = page.get_pixmap(clip=crop_rect, dpi=150)
    img = Image.frombytes("RGB", [pix.width, pix.height], pix.samples)
    img.save(output_image_path)
    doc.close()
    return True

# --- app/main.py ---
from fastapi import FastAPI, UploadFile, Form, File
from fastapi.responses import FileResponse, HTMLResponse
from fastapi.staticfiles import StaticFiles
import os
import shutil
from pdf_processor import crop_pdf, extract_text_to_csv
from utils import generate_middle_preview

app = FastAPI()
app.mount("/static", StaticFiles(directory="app/static"), name="static")

@app.get("/")
def index():
    with open("app/static/index.html", "r", encoding="utf-8") as f:
        return HTMLResponse(f.read())

@app.post("/process")
async def process(file: UploadFile = File(...), top_cm: float = Form(2.5), bottom_cm: float = Form(2.5)):
    filename = file.filename
    temp_path = f"app/outputs/{filename}"
    with open(temp_path, "wb") as f:
        shutil.copyfileobj(file.file, f)
    top_px = top_cm * 28.35
    bottom_px = bottom_cm * 28.35
    cropped_pdf = f"app/outputs/cropped_{filename}"
    csv_path = f"app/outputs/structured_{filename.replace('.pdf','.csv')}"
    jpg_path = f"app/outputs/preview_{filename.replace('.pdf','.jpg')}"

    crop_pdf(temp_path, cropped_pdf, top_px, bottom_px)
    extract_text_to_csv(temp_path, csv_path, top_px, bottom_px)
    generate_middle_preview(temp_path, jpg_path, top_px, bottom_px)
    os.remove(temp_path)
    return {
        "preview": f"/{jpg_path}",
        "pdf": f"/{cropped_pdf}",
        "csv": f"/{csv_path}"
    }

@app.get("/download")
def download(path: str):
    return FileResponse(path, filename=os.path.basename(path))

# --- app/static/index.html ---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PDF å‰ªè£å·¥å…·</title>
</head>
<body>
  <h2>ä¸Šä¼  PDF æ–‡ä»¶</h2>
  <form id="uploadForm">
    <input type="file" name="file" required><br>
    <label>é¡µçœ‰ (cm): <input type="number" name="top_cm" value="2.5"></label><br>
    <label>é¡µè„š (cm): <input type="number" name="bottom_cm" value="2.5"></label><br>
    <button type="submit">æäº¤å¤„ç†</button>
  </form>
  <div id="result" style="display:none">
    <h3>é¢„è§ˆä¸­é—´é¡µï¼š</h3>
    <img id="preview" style="max-width:600px"><br>
    <a id="pdfLink" download>ä¸‹è½½è£å‰ªå PDF</a> |
    <a id="csvLink" download>ä¸‹è½½æå–åçš„ CSV</a>
  </div>
  <script>
    const form = document.getElementById("uploadForm")
    form.onsubmit = async (e) => {
      e.preventDefault()
      const data = new FormData(form)
      const res = await fetch("/process", {method: "POST", body: data})
      const json = await res.json()
      document.getElementById("preview").src = json.preview
      document.getElementById("pdfLink").href = json.pdf
      document.getElementById("csvLink").href = json.csv
      document.getElementById("result").style.display = "block"
    }
  </script>
</body>
</html>

# --- requirements.txt ---
fastapi
uvicorn
python-multipart
PyMuPDF
pillow

# --- Dockerfile ---
FROM python:3.10-slim
WORKDIR /app
COPY . /app
RUN pip install --no-cache-dir -r requirements.txt
EXPOSE 8000
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
