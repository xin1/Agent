ä¸ºäº†ç¾åŒ–å‰ç«¯å¹¶å¢åŠ é¢„è§ˆåŠŸèƒ½ï¼Œæˆ‘ä»¬å°†å¯¹ç°æœ‰çš„ HTML ç»“æ„è¿›è¡Œä¿®æ”¹ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚æˆ‘ä»¬å°†åŸºäº `FastAPI` åç«¯ + é™æ€ HTML é¡µé¢è¿›è¡Œä»¥ä¸‹æ­¥éª¤ã€‚

---

### ğŸ“ é¡¹ç›®ç»“æ„

```bash
pdf_tool/
â”œâ”€â”€ app.py                  # FastAPI åº”ç”¨ä¸»ç¨‹åº
â”œâ”€â”€ pdf_processor.py        # PDF å‰ªè£+ç»“æ„æå–é€»è¾‘
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ index.html          # é™æ€ç½‘é¡µï¼ˆä¸Šä¼ æ–‡ä»¶å’Œä¸‹è½½ç»“æœï¼‰
â”œâ”€â”€ static/                 # é™æ€èµ„æºï¼ˆå¯ç•™ç©ºï¼‰
â”œâ”€â”€ requirements.txt        # Python ä¾èµ–
â”œâ”€â”€ Dockerfile              # Docker é•œåƒæ„å»ºé…ç½®
â””â”€â”€ output/                 # ç”Ÿæˆæ–‡ä»¶ä¿å­˜ç›®å½•ï¼ˆDocker ä¼šæŒ‚è½½ï¼‰
```

---

### âœ… 1. `requirements.txt`

```txt
fastapi
uvicorn
python-multipart
jinja2
pdfplumber
PyMuPDF
```

---

### âœ… 2. `pdf_processor.py`

```python
import fitz  # PyMuPDF
import pdfplumber
import re
import csv
import os

def process_pdf(pdf_path: str, top_cm: float, bottom_cm: float):
    # å•ä½æ¢ç®—
    top_px = int(top_cm * 28.35)
    bottom_px = int(bottom_cm * 28.35)

    cropped_path = pdf_path.replace(".pdf", "_cropped.pdf")
    csv_path = pdf_path.replace(".pdf", ".csv")

    # è£å‰ª PDF
    doc = fitz.open(pdf_path)
    for page in doc:
        rect = page.rect
        crop_rect = fitz.Rect(rect.x0, rect.y0 + top_px, rect.x1, rect.y1 - bottom_px)
        page.set_cropbox(crop_rect)
    doc.save(cropped_path)
    doc.close()

    # æå–ç»“æ„åŒ–ä¿¡æ¯
    with open(csv_path, "w", newline='', encoding='utf-8-sig') as f:
        writer = csv.writer(f)
        writer.writerow(["æ ‡é¢˜", "å†…å®¹"])

        current_title = None
        current_content = []

        with pdfplumber.open(cropped_path) as pdf:
            for page in pdf.pages:
                text = page.extract_text()
                if not text:
                    continue
                for line in text.split('\n'):
                    line = line.strip()
                    if not line:
                        continue
                    if is_heading(line):
                        if current_title:
                            writer.writerow([current_title, '\n'.join(current_content)])
                        current_title = line
                        current_content = []
                    elif current_title:
                        current_content.append(line)
        if current_title:
            writer.writerow([current_title, '\n'.join(current_content)])

    return cropped_path, csv_path

def is_heading(line):
    if len(line) > 50:
        return False
    return bool(re.match(r'^\d+(\.\d+){0,2}(\s+|$)', line.strip()))
```

---

### âœ… 3. `app.py`

```python
from fastapi import FastAPI, File, UploadFile, Form, Request
from fastapi.responses import HTMLResponse, FileResponse, JSONResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates
from pathlib import Path
import shutil
import fitz  # PyMuPDF
import uuid
from pdf_utils import crop_pdf_and_extract_text  # ä½ å·²æœ‰çš„å¤„ç†å‡½æ•°

app = FastAPI()
app.mount("/static", StaticFiles(directory="static"), name="static")
templates = Jinja2Templates(directory="templates")

UPLOAD_DIR = Path("uploads")
RESULT_DIR = Path("results")
PREVIEW_DIR = Path("previews")
UPLOAD_DIR.mkdir(exist_ok=True)
RESULT_DIR.mkdir(exist_ok=True)
PREVIEW_DIR.mkdir(exist_ok=True)

@app.get("/", response_class=HTMLResponse)
async def home(request: Request):
    return templates.TemplateResponse("index.html", {"request": request})

@app.post("/process/")
async def process_pdf(file: UploadFile = File(...), top_cm: float = Form(...), bottom_cm: float = Form(...)):
    # ä¿å­˜ä¸Šä¼ æ–‡ä»¶
    uid = uuid.uuid4().hex
    input_pdf = UPLOAD_DIR / f"{uid}_{file.filename}"
    with input_pdf.open("wb") as f:
        shutil.copyfileobj(file.file, f)

    # å¤„ç†å¹¶ç”Ÿæˆè¾“å‡º
    cropped_pdf_path = RESULT_DIR / f"{uid}_cropped.pdf"
    csv_path = RESULT_DIR / f"{uid}_output.csv"
    crop_pdf_and_extract_text(input_pdf, cropped_pdf_path, csv_path, top_cm, bottom_cm)

    return JSONResponse({
        "pdf": f"/results/{cropped_pdf_path.name}",
        "csv": f"/results/{csv_path.name}"
    })

@app.get("/download/")
async def download_file(path: str):
    file_path = Path(path.strip("/"))
    if file_path.exists():
        return FileResponse(file_path, filename=file_path.name)
    return {"error": "æ–‡ä»¶ä¸å­˜åœ¨"}

@app.get("/preview/")
async def preview_image(pdf_path: str):
    pdf_file = Path(pdf_path.strip("/"))
    if not pdf_file.exists():
        return JSONResponse({"error": "PDF æ–‡ä»¶æœªæ‰¾åˆ°"}, status_code=404)

    # ç”Ÿæˆé¢„è§ˆå›¾åƒ
    doc = fitz.open(pdf_file)
    page = doc.load_page(0)
    pix = page.get_pixmap(dpi=150)
    img_path = PREVIEW_DIR / f"{pdf_file.stem}.jpg"
    pix.save(img_path)

    return FileResponse(img_path, media_type="image/jpeg")

```

---

### âœ… 4. `templates/index.html`ï¼ˆå¢åŠ ç¾åŒ–å’Œé¢„è§ˆåŠŸèƒ½ï¼‰

```html
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>PDFè£å‰ªä¸æå–å·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #drop-area {
            border: 2px dashed #0d6efd;
            padding: 30px;
            text-align: center;
            color: #666;
            background-color: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        #drop-area.hover {
            border-color: #198754;
            background-color: #e9fbe5;
        }
        #file-name {
            margin-top: 10px;
            font-weight: bold;
            color: #0d6efd;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-5">
    <h2 class="mb-4 text-center text-primary">ğŸ“„ PDFè£å‰ªä¸ç»“æ„æå–å·¥å…·</h2>
    <div class="row">
        <div class="col-md-6">
            <!-- æ‹–æ‹½ä¸Šä¼ åŒº -->
            <div id="drop-area" class="mb-3">
                <p>å°† PDF æ–‡ä»¶æ‹–æ‹½åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ </p>
                <div id="file-name">æœªé€‰æ‹©æ–‡ä»¶</div>
            </div>

            <form id="upload-form" enctype="multipart/form-data" class="bg-white p-4 shadow rounded">
                <div class="mb-3">
                    <input class="form-control" type="file" id="file" name="file" accept="application/pdf" required>
                </div>
                <div class="row mb-3">
                    <div class="col">
                        <label class="form-label">ä¸Šè¾¹è·è£å‰ª (cm)</label>
                        <input class="form-control" type="number" name="top_cm" id="top_cm" value="2.5" step="0.1">
                    </div>
                    <div class="col">
                        <label class="form-label">ä¸‹è¾¹è·è£å‰ª (cm)</label>
                        <input class="form-control" type="number" name="bottom_cm" id="bottom_cm" value="2.5" step="0.1">
                    </div>
                </div>
                <button class="btn btn-primary w-100" type="submit">ğŸ“¤ æäº¤å¤„ç†</button>
            </form>

            <div id="download-links" class="text-center mt-4" style="display:none;">
                <a id="pdf-link" class="btn btn-success me-2" download>ğŸ“¥ ä¸‹è½½è£å‰ªå PDF</a>
                <a id="csv-link" class="btn btn-outline-primary" download>ğŸ“Š ä¸‹è½½ç»“æ„åŒ– CSV</a>
            </div>
        </div>

        <!-- å³ä¾§é¢„è§ˆ -->
        <div class="col-md-6 d-flex flex-column align-items-center justify-content-center">
            <h5 class="text-success mb-3">âœ… å‰ªè£é¢„è§ˆ</h5>
            <div id="preview" style="display:none;">
                <img id="preview-image" class="img-fluid border rounded shadow" style="max-height: 600px;" alt="è£å‰ªé¢„è§ˆå›¾">
            </div>
        </div>
    </div>
</div>

<script>
const dropArea = document.getElementById("drop-area");
const fileInput = document.getElementById("file");
const fileNameDisplay = document.getElementById("file-name");

// æ‹–æ‹½å¤„ç†
["dragenter", "dragover"].forEach(evt => {
    dropArea.addEventListener(evt, (e) => {
        e.preventDefault();
        dropArea.classList.add("hover");
    });
});
["dragleave", "drop"].forEach(evt => {
    dropArea.addEventListener(evt, (e) => {
        e.preventDefault();
        dropArea.classList.remove("hover");
    });
});
dropArea.addEventListener("drop", function (e) {
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        fileInput.files = files;
        fileNameDisplay.textContent = files[0].name;
    }
});
fileInput.addEventListener("change", () => {
    if (fileInput.files.length > 0) {
        fileNameDisplay.textContent = fileInput.files[0].name;
    }
});

// è¡¨å•æäº¤é€»è¾‘
document.getElementById("upload-form").addEventListener("submit", async function (e) {
    e.preventDefault();
    const file = fileInput.files[0];
    if (!file) return alert("è¯·é€‰æ‹©ä¸€ä¸ª PDF æ–‡ä»¶");

    const top_cm = document.getElementById("top_cm").value;
    const bottom_cm = document.getElementById("bottom_cm").value;
    const formData = new FormData();
    formData.append("file", file);
    formData.append("top_cm", top_cm);
    formData.append("bottom_cm", bottom_cm);

    const response = await fetch("/process/", {
        method: "POST",
        body: formData
    });

    if (!response.ok) {
        alert("å¤„ç†å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æˆ–å‚æ•°");
        return;
    }

    const result = await response.json();
    // æ›´æ–°é¢„è§ˆå›¾
    document.getElementById("preview").style.display = "block";
    document.getElementById("preview-image").src = `/preview/?pdf_path=${encodeURIComponent(result.pdf)}&t=${Date.now()}`;
    // æ›´æ–°ä¸‹è½½é“¾æ¥
    document.getElementById("download-links").style.display = "block";
    document.getElementById("pdf-link").href = `/download/?path=${encodeURIComponent(result.pdf)}`;
    document.getElementById("csv-link").href = `/download/?path=${encodeURIComponent(result.csv)}`;
});
</script>
</body>
</html>

```

---

### âœ… 5. `Dockerfile`

```Dockerfile
FROM python:3.10
WORKDIR /app

COPY . . 

RUN pip install --no-cache-dir -r requirements.txt

EXPOSE 8000

CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8000"]
```

---

### âœ… 6. æ„å»ºå¹¶è¿è¡Œ Docker å®¹å™¨

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd pdf_tool

# æ„å»ºé•œåƒ
docker build -t pdf-tool-app .

# å¯åŠ¨å®¹å™¨ï¼ˆæŒ‡å®šç«¯å£æ˜ å°„ï¼‰
docker run -d -p 8090:8000 --name pdf_tool_app pdf-tool-app
```

ç„¶åè®¿é—®ï¼š

```
http://<ä½ çš„äº‘æœåŠ¡å™¨IP>:8090/
```

---

è¿™æ ·ï¼Œæ‚¨å°±å¯ä»¥é€šè¿‡ Docker å®¹å™¨è¿è¡Œé¡¹ç›®ï¼Œå¹¶æä¾›ä¸€ä¸ªç¾è§‚çš„å‰ç«¯é¡µé¢ï¼Œç”¨æˆ·å¯ä»¥ä¸Šä¼  PDF æ–‡ä»¶ï¼Œè®¾ç½®è£å‰ªå‚æ•°ï¼Œé¢„è§ˆç»“æœï¼Œå¹¶ä¸‹è½½è£å‰ªåçš„ PDF å’Œç»“æ„åŒ–çš„ CSV æ–‡ä»¶ã€‚

<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>PDFå‰ªè£ä¸æå–å·¥å…·</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-5">
    <h2 class="mb-4 text-center text-primary">ğŸ“„ PDFè£å‰ªä¸ç»“æ„æå–å·¥å…·</h2>
    <form id="upload-form" enctype="multipart/form-data" class="bg-white p-4 shadow rounded">
        <div class="mb-3">
            <label for="file" class="form-label">ä¸Šä¼ PDFæ–‡ä»¶</label>
            <input class="form-control" type="file" id="file" name="file" accept="application/pdf" required>
        </div>
        <div class="row mb-3">
            <div class="col">
                <label class="form-label">ä¸Šè¾¹è·è£å‰ª (cm)</label>
                <input class="form-control" type="number" name="top_cm" value="2.5" step="0.1">
            </div>
            <div class="col">
                <label class="form-label">ä¸‹è¾¹è·è£å‰ª (cm)</label>
                <input class="form-control" type="number" name="bottom_cm" value="2.5" step="0.1">
            </div>
        </div>
        <button class="btn btn-primary w-100" type="submit">æäº¤å¤„ç†</button>
    </form>

    <div id="preview" class="text-center my-4" style="display:none;">
        <h5 class="text-success">âœ… é¢„è§ˆå‰ªè£æ•ˆæœ</h5>
        <img id="preview-image" class="img-fluid border rounded shadow" alt="è£å‰ªé¢„è§ˆå›¾">
    </div>

    <div id="download-links" class="text-center mt-4" style="display:none;">
        <a id="pdf-link" class="btn btn-success me-2" download>ä¸‹è½½è£å‰ªå PDF</a>
        <a id="csv-link" class="btn btn-outline-primary" download>ä¸‹è½½ç»“æ„åŒ– CSV</a>
    </div>
</div>

<script>
document.getElementById("upload-form").addEventListener("submit", async function (e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);
    const file = form.file.files[0];

    if (!file) return alert("è¯·é€‰æ‹©ä¸€ä¸ª PDF æ–‡ä»¶");

    const response = await fetch("/process/", {
        method: "POST",
        body: formData
    });

    if (!response.ok) {
        alert("å¤„ç†å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–é‡è¯•");
        return;
    }

    const result = await response.json();
    document.getElementById("preview").style.display = "block";
    document.getElementById("preview-image").src = `/preview/?pdf_path=${encodeURIComponent(result.pdf)}`;

    document.getElementById("download-links").style.display = "block";
    document.getElementById("pdf-link").href = `/download/?path=${encodeURIComponent(result.pdf)}`;
    document.getElementById("csv-link").href = `/download/?path=${encodeURIComponent(result.csv)}`;
});
</script>
</body>
</html>

from fastapi import FastAPI, UploadFile, File, Form
from fastapi.responses import FileResponse, JSONResponse
from fastapi.staticfiles import StaticFiles
import os
from io import BytesIO
from PyPDF2 import PdfReader, PdfWriter
import pandas as pd

app = FastAPI()

# é™æ€æ–‡ä»¶ç›®å½•ï¼Œä¾›å‰ç«¯é¢„è§ˆå’Œä¸‹è½½ä½¿ç”¨
app.mount("/static", StaticFiles(directory="static"), name="static")

# ä¸´æ—¶ç›®å½•
TEMP_DIR = "temp"

# ç¡®ä¿ä¸´æ—¶ç›®å½•å­˜åœ¨
os.makedirs(TEMP_DIR, exist_ok=True)

def crop_pdf(input_path: str, output_path: str, top_cm: float, bottom_cm: float):
    # è£å‰ªPDFå‡½æ•°
    reader = PdfReader(input_path)
    writer = PdfWriter()

    # è½¬æ¢å˜ç±³ä¸ºç‚¹ï¼ˆ1 cm â‰ˆ 28.35 pointsï¼‰
    top = top_cm * 28.35
    bottom = bottom_cm * 28.35

    # å¯¹æ¯ä¸€é¡µè¿›è¡Œè£å‰ª
    for page_num in range(len(reader.pages)):
        page = reader.pages[page_num]
        page.cropbox.upper_left = (0, top)  # å·¦ä¸Š
        page.cropbox.lower_right = (page.mediabox.width, page.mediabox.height - bottom)  # å³ä¸‹
        writer.add_page(page)

    # ä¿å­˜è£å‰ªåçš„PDF
    with open(output_path, "wb") as out_file:
        writer.write(out_file)

def generate_csv_from_pdf(input_path: str) -> str:
    # ç¤ºä¾‹å‡½æ•°ï¼šä»PDFæå–ä¸€äº›ç»“æ„åŒ–æ•°æ®
    # è¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿï¼Œå°†PDFé¡µé¢æ•°ä½œä¸ºç»“æ„åŒ–æ•°æ®
    reader = PdfReader(input_path)
    data = {"page_number": list(range(1, len(reader.pages) + 1))}
    df = pd.DataFrame(data)
    
    # ä¿å­˜ä¸ºCSV
    csv_path = os.path.join(TEMP_DIR, "output.csv")
    df.to_csv(csv_path, index=False)
    return csv_path

@app.post("/process/")
async def process_pdf(file: UploadFile = File(...), top_cm: float = Form(2.5), bottom_cm: float = Form(2.5)):
    # ä¿å­˜ä¸Šä¼ çš„PDFæ–‡ä»¶
    input_pdf_path = os.path.join(TEMP_DIR, file.filename)
    with open(input_pdf_path, "wb") as f:
        f.write(await file.read())

    # è¾“å‡ºè£å‰ªåçš„PDFè·¯å¾„
    output_pdf_path = os.path.join(TEMP_DIR, f"cropped_{file.filename}")
    crop_pdf(input_pdf_path, output_pdf_path, top_cm, bottom_cm)

    # ç”Ÿæˆç»“æ„åŒ–CSV
    csv_path = generate_csv_from_pdf(input_pdf_path)

    # è¿”å›å¤„ç†ç»“æœ
    return JSONResponse(content={
        "pdf": output_pdf_path.replace(TEMP_DIR + "/", ""),
        "csv": csv_path.replace(TEMP_DIR + "/", "")
    })

@app.get("/preview/")
async def preview_pdf(pdf_path: str):
    # è¿”å›è£å‰ªåçš„PDFé¢„è§ˆï¼ˆè¿™é‡Œå‡è®¾å‰ç«¯ä¼ çš„æ˜¯ä¸€ä¸ªå›¾ç‰‡è·¯å¾„ï¼Œå®é™…å¯ç”¨PDFæ¸²æŸ“å™¨å¦‚PDF.jsï¼‰
    return FileResponse(pdf_path)

@app.get("/download/")
async def download_file(path: str):
    file_path = os.path.join(TEMP_DIR, path)
    if os.path.exists(file_path):
        return FileResponse(file_path, media_type="application/octet-stream", filename=path)
    return JSONResponse(content={"message": "File not found"}, status_code=404)


project/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py              # FastAPI åç«¯æœåŠ¡å…¥å£
â”‚   â”œâ”€â”€ pdf_processor.py     # å‰ªè£ PDF å’Œç»“æ„åŒ–æå–é€»è¾‘
â”‚   â”œâ”€â”€ utils.py             # ä¸­é—´é¡µç”Ÿæˆé¢„è§ˆå›¾çš„å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ static/
â”‚   â”‚   â””â”€â”€ index.html       # å‰ç«¯ç½‘é¡µï¼ˆä¸Šä¼ ã€é¢„è§ˆã€ä¸‹è½½ï¼‰
â”‚   â””â”€â”€ outputs/             # ç”Ÿæˆçš„ PDF/CSV/JPEG ä¸´æ—¶æ–‡ä»¶ç›®å½•
â”œâ”€â”€ Dockerfile               # Docker æ„å»ºæ–‡ä»¶
â”œâ”€â”€ requirements.txt         # ä¾èµ–æ¸…å•
â””â”€â”€ README.md                # éƒ¨ç½²ä¸ä½¿ç”¨è¯´æ˜

# --- app/pdf_processor.py ---
import fitz  # PyMuPDF
import re
import os

def crop_pdf(input_pdf, output_pdf, top_crop, bottom_crop):
    doc = fitz.open(input_pdf)
    for page in doc:
        rect = page.rect
        crop_rect = fitz.Rect(
            rect.x0, rect.y0 + top_crop, rect.x1, rect.y1 - bottom_crop
        )
        page.set_cropbox(crop_rect)
    doc.save(output_pdf)
    doc.close()

def extract_text_to_csv(input_pdf, output_csv, top_crop, bottom_crop):
    import csv
    doc = fitz.open(input_pdf)
    with open(output_csv, 'w', newline='', encoding='utf-8-sig') as f:
        writer = csv.writer(f)
        writer.writerow(['æ ‡é¢˜', 'å†…å®¹'])
        current_title = None
        current_content = []
        for page in doc:
            rect = page.rect
            crop_rect = fitz.Rect(rect.x0, rect.y0 + top_crop, rect.x1, rect.y1 - bottom_crop)
            text = page.get_text(clip=crop_rect)
            if not text:
                continue
            for line in text.split('\n'):
                line = line.strip()
                if not line:
                    continue
                if is_header(line):
                    if current_title:
                        writer.writerow([current_title, '\n'.join(current_content)])
                    current_title = line
                    current_content = []
                else:
                    current_content.append(line)
        if current_title:
            writer.writerow([current_title, '\n'.join(current_content)])
    doc.close()

def is_header(line):
    return bool(re.match(r'^\d+(\.\d+){0,2}\s+', line)) and len(line) <= 50

# --- app/utils.py ---
import fitz
from PIL import Image

def generate_middle_preview(input_pdf, output_image_path, top_crop, bottom_crop):
    doc = fitz.open(input_pdf)
    if len(doc) == 0:
        return False
    mid_index = len(doc) // 2
    page = doc[mid_index]
    rect = page.rect
    crop_rect = fitz.Rect(
        rect.x0, rect.y0 + top_crop, rect.x1, rect.y1 - bottom_crop
    )
    pix = page.get_pixmap(clip=crop_rect, dpi=150)
    img = Image.frombytes("RGB", [pix.width, pix.height], pix.samples)
    img.save(output_image_path)
    doc.close()
    return True

# --- app/main.py ---
from fastapi import FastAPI, UploadFile, Form, File
from fastapi.responses import FileResponse, HTMLResponse
from fastapi.staticfiles import StaticFiles
import os
import shutil
from pdf_processor import crop_pdf, extract_text_to_csv
from utils import generate_middle_preview

app = FastAPI()
app.mount("/static", StaticFiles(directory="app/static"), name="static")

@app.get("/")
def index():
    with open("app/static/index.html", "r", encoding="utf-8") as f:
        return HTMLResponse(f.read())

@app.post("/process")
async def process(file: UploadFile = File(...), top_cm: float = Form(2.5), bottom_cm: float = Form(2.5)):
    filename = file.filename
    temp_path = f"app/outputs/{filename}"
    with open(temp_path, "wb") as f:
        shutil.copyfileobj(file.file, f)
    top_px = top_cm * 28.35
    bottom_px = bottom_cm * 28.35
    cropped_pdf = f"app/outputs/cropped_{filename}"
    csv_path = f"app/outputs/structured_{filename.replace('.pdf','.csv')}"
    jpg_path = f"app/outputs/preview_{filename.replace('.pdf','.jpg')}"

    crop_pdf(temp_path, cropped_pdf, top_px, bottom_px)
    extract_text_to_csv(temp_path, csv_path, top_px, bottom_px)
    generate_middle_preview(temp_path, jpg_path, top_px, bottom_px)
    os.remove(temp_path)
    return {
        "preview": f"/{jpg_path}",
        "pdf": f"/{cropped_pdf}",
        "csv": f"/{csv_path}"
    }

@app.get("/download")
def download(path: str):
    return FileResponse(path, filename=os.path.basename(path))

# --- app/static/index.html ---
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PDF å‰ªè£å·¥å…·</title>
</head>
<body>
  <h2>ä¸Šä¼  PDF æ–‡ä»¶</h2>
  <form id="uploadForm">
    <input type="file" name="file" required><br>
    <label>é¡µçœ‰ (cm): <input type="number" name="top_cm" value="2.5"></label><br>
    <label>é¡µè„š (cm): <input type="number" name="bottom_cm" value="2.5"></label><br>
    <button type="submit">æäº¤å¤„ç†</button>
  </form>
  <div id="result" style="display:none">
    <h3>é¢„è§ˆä¸­é—´é¡µï¼š</h3>
    <img id="preview" style="max-width:600px"><br>
    <a id="pdfLink" download>ä¸‹è½½è£å‰ªå PDF</a> |
    <a id="csvLink" download>ä¸‹è½½æå–åçš„ CSV</a>
  </div>
  <script>
    const form = document.getElementById("uploadForm")
    form.onsubmit = async (e) => {
      e.preventDefault()
      const data = new FormData(form)
      const res = await fetch("/process", {method: "POST", body: data})
      const json = await res.json()
      document.getElementById("preview").src = json.preview
      document.getElementById("pdfLink").href = json.pdf
      document.getElementById("csvLink").href = json.csv
      document.getElementById("result").style.display = "block"
    }
  </script>
</body>
</html>

# --- requirements.txt ---
fastapi
uvicorn
python-multipart
PyMuPDF
pillow

# --- Dockerfile ---
FROM python:3.10-slim
WORKDIR /app
COPY . /app
RUN pip install --no-cache-dir -r requirements.txt
EXPOSE 8000
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
