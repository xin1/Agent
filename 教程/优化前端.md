以下是完整的 PDF 剪裁与结构提取工具（支持预览、CSV 提取、进度条、多文档打包下载）前后端 + Docker 部署方案：

---

## ✅ 一、功能总览

支持功能：

* ✅ 拖拽/多选上传 PDF；
* ✅ 设置上下裁剪距离；
* ✅ 剪裁效果预览；
* ✅ 结构化数据提取为 CSV；
* ✅ 多文档压缩打包；
* ✅ 下载按钮动态显示；
* ✅ 进度条；
* ✅ Docker 一键部署。

---

## 📁 二、目录结构

```
pdf-tool/
├── app.py
├── process.py
├── preview.py
├── zip_util.py
├── static/
│   ├── index.html
│   └── style.css
├── outputs/                  # 自动生成的预览图和CSV
├── Dockerfile
└── requirements.txt
```

---

## 🐍 三、后端核心代码（FastAPI）

### ✅ 1. `app.py`

```python
from fastapi import FastAPI, File, UploadFile, Form
from fastapi.responses import FileResponse, HTMLResponse
from fastapi.staticfiles import StaticFiles
from fastapi.middleware.cors import CORSMiddleware
from typing import List
import os
from process import process_pdf_and_extract
from preview import generate_preview_image
from zip_util import zip_csvs

app = FastAPI()
app.mount("/static", StaticFiles(directory="static"), name="static")
app.mount("/outputs", StaticFiles(directory="outputs"), name="outputs")

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"], allow_methods=["*"], allow_headers=["*"]
)

@app.get("/")
async def root():
    with open("static/index.html", "r", encoding="utf-8") as f:
        return HTMLResponse(content=f.read(), status_code=200)

@app.post("/preview/")
async def preview(file: UploadFile = File(...), top_cm: float = Form(...), bottom_cm: float = Form(...)):
    preview_path = generate_preview_image(file, top_cm, bottom_cm)
    return {"preview_path": preview_path}

@app.post("/process_batch/")
async def process_batch(files: List[UploadFile] = File(...), top_cm: float = Form(...), bottom_cm: float = Form(...)):
    csv_paths = []
    for file in files:
        csv_path = process_pdf_and_extract(file, top_cm, bottom_cm)
        csv_paths.append(csv_path)

    if len(csv_paths) == 1:
        return {"path": csv_paths[0], "is_zip": False}
    else:
        zip_path = zip_csvs(csv_paths)
        return {"path": zip_path, "is_zip": True}

@app.get("/download/")
async def download(path: str):
    return FileResponse(path, filename=os.path.basename(path))
```

---

### ✅ 2. `process.py`

```python
import os
import fitz  # PyMuPDF
import csv
from uuid import uuid4

os.makedirs("outputs", exist_ok=True)

def process_pdf_and_extract(file, top_cm, bottom_cm):
    pdf = fitz.open(stream=file.file.read(), filetype="pdf")
    filename = file.filename.rsplit('.', 1)[0]
    csv_path = f"outputs/{uuid4().hex}_{filename}.csv"

    with open(csv_path, "w", newline="", encoding="utf-8") as f:
        writer = csv.writer(f)
        for page in pdf:
            rect = page.rect
            top = top_cm * 28.35
            bottom = bottom_cm * 28.35
            clip = fitz.Rect(rect.x0, rect.y0 + top, rect.x1, rect.y1 - bottom)
            text = page.get_text("blocks", clip=clip)
            for block in text:
                writer.writerow([block[4].strip()])  # 内容

    return csv_path
```

---

### ✅ 3. `preview.py`

```python
import fitz
from uuid import uuid4
import os

def generate_preview_image(file, top_cm, bottom_cm):
    os.makedirs("outputs", exist_ok=True)
    pdf = fitz.open(stream=file.file.read(), filetype="pdf")
    page = pdf.load_page(0)
    rect = page.rect
    top = top_cm * 28.35
    bottom = bottom_cm * 28.35
    clip = fitz.Rect(rect.x0, rect.y0 + top, rect.x1, rect.y1 - bottom)

    pix = page.get_pixmap(dpi=150, clip=clip)
    path = f"outputs/{uuid4().hex}_preview.png"
    pix.save(path)
    return path
```

---

### ✅ 4. `zip_util.py`

```python
import zipfile
from uuid import uuid4
import os

def zip_csvs(paths):
    zip_name = f"outputs/{uuid4().hex}_csvs.zip"
    with zipfile.ZipFile(zip_name, 'w') as z:
        for path in paths:
            z.write(path, os.path.basename(path))
    return zip_name
```

---

## 🌐 四、前端文件（静态资源）

### ✅ `static/index.html`

```html
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>PDF结构提取工具</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <h1>PDF结构提取工具</h1>

  <input type="file" id="pdf-input" multiple accept=".pdf">
  <p id="file-names" class="text-muted mt-2"></p>

  <label>上裁剪距离 (cm)：<input type="number" id="top" value="2" step="0.1"></label>
  <label>下裁剪距离 (cm)：<input type="number" id="bottom" value="2" step="0.1"></label>

  <button onclick="previewPDF()">预览剪裁效果</button>
  <img id="preview-img" style="max-width: 100%; margin: 10px 0; display: none;" />

  <button onclick="processPDFs()">生成结构CSV</button>
  <progress id="progress-bar" value="0" max="100" style="width: 100%; display: none;"></progress>

  <div id="download-links" style="display: none;">
    <a id="csv-link" href="#" download>下载</a>
  </div>

<script>
const input = document.getElementById("pdf-input");
input.addEventListener("change", () => {
  const names = Array.from(input.files).map(f => f.name).join("；");
  document.getElementById("file-names").textContent = "已选文件：" + names;
});

function previewPDF() {
  const file = input.files[0];
  if (!file) return alert("请选择一个文件进行预览");
  const form = new FormData();
  form.append("file", file);
  form.append("top_cm", document.getElementById("top").value);
  form.append("bottom_cm", document.getElementById("bottom").value);

  fetch("/preview/", { method: "POST", body: form })
    .then(res => res.json())
    .then(data => {
      const img = document.getElementById("preview-img");
      img.src = "/" + data.preview_path;
      img.style.display = "block";
    });
}

function processPDFs() {
  const files = input.files;
  if (files.length === 0) return alert("请上传PDF文件");
  const form = new FormData();
  for (let i = 0; i < files.length; i++) form.append("files", files[i]);
  form.append("top_cm", document.getElementById("top").value);
  form.append("bottom_cm", document.getElementById("bottom").value);

  const xhr = new XMLHttpRequest();
  xhr.open("POST", "/process_batch/", true);

  const bar = document.getElementById("progress-bar");
  bar.style.display = "block";
  bar.value = 0;

  xhr.upload.onprogress = e => {
    if (e.lengthComputable) bar.value = (e.loaded / e.total) * 100;
  };

  xhr.onload = () => {
    const res = JSON.parse(xhr.responseText);
    document.getElementById("download-links").style.display = "block";
    const csvLink = document.getElementById("csv-link");
    csvLink.href = `/download/?path=${res.path}`;
    csvLink.textContent = res.is_zip ? "下载CSV压缩包" : "下载CSV文件";
  };

  xhr.send(form);
}
</script>
</body>
</html>
```

---

### ✅ `static/style.css`（可选）

```css
body {
  max-width: 720px;
  margin: auto;
  font-family: sans-serif;
}
h1 {
  color: #007bff;
}
button {
  margin: 10px 0;
  padding: 8px 12px;
}
input[type="file"] {
  margin: 10px 0;
}
```

---

## 🐳 五、Docker部署

### ✅ `requirements.txt`

```txt
fastapi
uvicorn
python-multipart
PyMuPDF
```

### ✅ `Dockerfile`

```Dockerfile
FROM python:3.10-slim

WORKDIR /app
COPY . /app

RUN pip install -r requirements.txt

EXPOSE 7860
CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "7860"]
```

---

## 🧪 六、一键运行流程

### ✅ 构建并运行容器：

```bash
docker build -t pdf-tool .
docker run -p 7860:7860 pdf-tool
```

访问：[http://localhost:7860](http://localhost:7860)

---

## ✅ 七、总结

你现在拥有一个完整的前后端 PDF 剪裁与结构提取工具，支持：

* 单/多文档裁剪；
* 裁剪预览；
* CSV结构提取；
* 动态下载按钮；
* 多文档自动压缩；
* Docker 一键部署。

需要我打包为 `.zip` 供你下载，或者生成一个 GitHub 初始化仓库结构吗？
